var windowWidth=800,windowHeight=480,container,stats,camera,scene,projector,renderer,mesh,p,mycanvas,mySpeed,myId,carMap={},carNameMap={},keydown={w:!1,s:!1,a:!1,d:!1},RAP=1,CAR_COLOR=["#ff0000","#0000CC","#FFFF00","#990099"],CAR_INIT_POS=[{x:12877,z:-2086},{x:13211,z:-2311},{x:12917,z:-2646},{x:13136,z:-2877}],reverseWatcher=0,goalWatcher=0,isStarted=!1;init();
function init(){container=document.getElementById("container");mycanvas=document.getElementById("mycanvas");mySpeed=document.getElementById("mySpeed");myRad=document.getElementById("myRad");camera=new THREE.PerspectiveCamera(50,windowWidth/windowHeight,1,1E4);scene=new THREE.Scene;var a=new THREE.DirectionalLight(15724543,2);a.position.set(1,1,1).normalize();scene.add(a);a=new THREE.DirectionalLight(16773103,2);a.position.set(-1,-1,-1).normalize();scene.add(a);var a=new THREE.PlaneGeometry(62E3,62E3),
d=new THREE.MeshPhongMaterial({color:26163});ground=new THREE.Mesh(a,d);ground.position.y=-1;ground.rotation.x=-Math.PI/2;scene.add(ground);d=THREE.ImageUtils.loadTexture("./images/_course.jpg");a=new THREE.PlaneGeometry(32E3,32E3);d=new THREE.MeshPhongMaterial({color:16777215,map:d});ground=new THREE.Mesh(a,d);ground.rotation.x=-Math.PI/2;ground.receiveShadow=!0;scene.add(ground);renderer=new THREE.WebGLRenderer({canvas:mycanvas});renderer.sortObjects=!1;renderer.setSize(windowWidth,windowHeight);
stats=new Stats;stats.domElement.style.position="absolute";stats.domElement.style.display="none";container.appendChild(stats.domElement);document.addEventListener("keydown",onKeyDown,!1);document.addEventListener("keyup",onKeyUp,!1)}function onWindowResize(){camera.aspect=windowWidth/windowHeight;camera.updateProjectionMatrix();renderer.setSize(windowWidth,windowHeight)}
function onKeyDown(a){switch(a.keyCode){case 38:case 87:keydown.w=!0;break;case 40:case 83:keydown.s=!0;break;case 37:case 65:keydown.a=!0;break;case 39:case 68:keydown.d=!0}}function onKeyUp(a){switch(a.keyCode){case 38:case 87:keydown.w=!1;break;case 40:case 83:keydown.s=!1;break;case 37:case 65:keydown.a=!1;break;case 39:case 68:keydown.d=!1}}function animate(){requestAnimationFrame(animate);render();stats.update()}
var carRad=0,carSp=0,carMaxSp=40,duration=500,keyframes=15,interpolation=duration/keyframes,lastKeyframe=0,currentKeyframe=0,gatagotoCnt=0,me,myname;
function startInit(){for(var a=0,d=raceMember.length;a<d;a++){var b=CAR_COLOR[a],f=CAR_INIT_POS[a];geometry=new THREE.CubeGeometry(100,50,100);material=new THREE.MeshLambertMaterial({color:b});mesh=new THREE.Mesh(geometry,material);mesh.position.x=f.x;mesh.position.y=50;mesh.position.z=f.z;carMap[raceMember[a].id]=mesh;myId===raceMember[a].id&&(me=mesh);scene.add(mesh);var b=new THREE.TextGeometry(raceMember[a].name,{size:12,height:1,material:0,extrudeMaterial:1,curveSegments:4,font:"helvetiker"}),
g=new THREE.MeshBasicMaterial({color:0}),b=new THREE.Mesh(b,g);b.position.x=f.x+20;b.position.y=120;b.position.z=f.z;b.rotation.x=0;b.rotation.y=3.1;carNameMap[raceMember[a].id]=b;myId===raceMember[a].id&&(myname=b);scene.add(b)}var c=3,e=setInterval(function(){3>=c+1&&(document.getElementById("start"+Number(c+1)).style.display="none");-1>=c?clearInterval(e):(document.getElementById("start"+c).style.display="block",c-=1,-2<c&&0>c?isStarted=!0:-1>c&&clearInterval(e))},1100)}
var draw=function(a){var d=carMap[a.id],b=carNameMap[a.id];d.rotation.y=a.rad;d.position.x=a.x;d.position.z=a.z;b.position.x=a.x;b.position.z=a.z};
function render(){if(mesh){var a=groundData[512*(Math.floor(me.position.x/62.5+256)-1)+Math.floor(me.position.z/62.5+256)];0===a?(carMaxSp=20,0<carSp&&(carSp-=0.1),keydown.w&&(50==me.position.y?(gatagotoCnt++,3<gatagotoCnt&&(me.position.y=52,gatagotoCnt=0)):(gatagotoCnt++,3<gatagotoCnt&&(me.position.y=50,gatagotoCnt=0))),goalWatcher=0):3===a?(1==goalWatcher&&(console.log("\u9806\u8d70"),0==reverseWatcher?(console.log("\u4e00\u5468\u3057\u305f\uff01"),checkMemberRapStatus()):reverseWatcher+=1),goalWatcher=
2):2===a?(2==goalWatcher&&(console.log("\u9006\u8d70"),reverseWatcher-=1),goalWatcher=1):(carMaxSp=40,goalWatcher=0);keydown.a&&isStarted&&!isFinished?(carRad+=0.01,carMaxSp<carSp&&(carSp=carMaxSp)):keydown.d&&isStarted&&!isFinished?(carRad-=0.01,carMaxSp<carSp&&(carSp=carMaxSp)):keydown.w?(carSp+=0.2,carMaxSp<carSp&&(carSp=carMaxSp)):(keydown.s&&isStarted&&!isFinished?carSp-=0.2:0<carSp&&(carSp-=0.7),0>carSp&&(carSp=0));isStarted&&!isFinished&&(0<carSp||keydown.a||keydown.d)&&(me.rotation.y=carRad,
me.position.x+=Math.sin(carRad)*carSp,me.position.z+=Math.cos(carRad)*carSp,myname.rotation.y=carRad+3.1,myname.position.x+=Math.sin(carRad)*carSp,myname.position.z+=Math.cos(carRad)*carSp,peer&&peer.sendData(raceMemberIdList,JSON.stringify({id:myId,rad:carRad,x:me.position.x,z:me.position.z})));camera.position.x||(camera.position.x=0);camera.position.z||(camera.position.z=0);mySpeed.innerHTML=Math.round(100*carSp)/100;camera.position.y=200;camera.position.x-=0.075*(camera.position.x-me.position.x+
330*Math.sin(carRad));camera.position.z-=0.075*(camera.position.z-me.position.z+330*Math.cos(carRad));camera.lookAt({x:me.position.x,y:100,z:me.position.z})}renderer.render(scene,camera)}
var checkMemberRapStatus=function(){memberRapMap[myId]+=1;console.log("rap "+memberRapMap[myId]);memberRapMap[myId]>RAP&&peer.finishGame(myId,joinedRoomId)},roomMemberMap={},raceMember,raceMemberIdList=[],memberRapMap={},peer,roomInfo,joinedRoomId,isFinished=!1,startScene=document.getElementById("startScene"),titleWrapper=document.getElementById("titleWrapper"),inputWrapper=document.getElementById("inputWrapper"),connectBtn=document.getElementById("connectBtn"),myName=document.getElementById("myName"),
roomListWrapper=document.getElementById("roomListWrapper"),roomListContainer=document.getElementById("roomListContainer"),newGameBtn=document.getElementById("newGameBtn"),waitWrapper=document.getElementById("waitWrapper"),joinMemberList=document.getElementById("joinMemberList"),mySpeedMeter=document.getElementById("mySpeedMeter");mySpeed=document.getElementById("mySpeed");var before,after,joinBtns=[];
connectBtn.addEventListener("click",function(a){formCheck(myName.value)?(inputWrapper.style.display="none",peer=new PeerMORGClient({name:myName.value}),peer.on("open",function(a){roomInfo=a;roomListContainer.innerHTML="";for(var b=0,f=!1,g=0;g<a.length;g++){var c=a[g];if(!f&&c&&1==c.member.length&&c.member[0].id==peer.getMyId()){joinedRoomId=c.roomId;joinMemberList.innerHTML="";waitWrapper.style.display="block";break}if(!(0>=c.remainTime||c.isStarted||c.isTimeout||c.isFinished)){b+=1;roomListWrapper.style.display=
"block";var f=!0,e="",e=e+'<div class="roomContainer mt10">',e=e+('<p class="raceName">RACE '+b+"</p>"),e=e+('<p class="roomRemainTime"><span class="fcYellow" id="roomRemainSec_'+c.roomId+'"></span>sec</p>'),e=e+('<p class="roomMember" id="roomMemberList_'+c.roomId+'"></p>'),e=e+('<input type="button" id="joinBtn_'+c.roomId+'" value="JOIN" class="joinBtn" data-room-id="'+c.roomId+'">'),e=e+('<p id="joinTxt_'+c.roomId+'" class="joinTxt" style="display:none;">joined</p>'),e=e+('<p id="closeTxt_'+c.roomId+
'" class="closeTxt" style="display:none;">closed</p>'),e=e+"</div>";roomListContainer.innerHTML+=e;roomMemberMap[c.roomId]=[];var e=c.member,k=document.getElementById("roomMemberList_"+c.roomId);k.innerHTML="";for(var h=0;h<e.length;h++)roomMemberMap[c.roomId].push(e[h].id),k.innerHTML+=" "+e[h].name}}setJoinBtnEvents()}),peer.on("created",function(a){joinedRoomId=a}),peer.on("join",function(a){console.log("join room "+a.roomId+" id "+a.id+" name "+a.name);joinedRoomId===a.roomId&&(roomMemberMap[a.roomId]||
(roomMemberMap[a.roomId]=[]),roomMemberMap[a.roomId].push(a.id),joinMemberList.innerHTML+='<p><span class="fcRed">'+a.name+"</span> joined!</p>");updateRoomInfo(a.roomId,a.id,a.name)}),peer.on("countdown",function(a){0===a?(waitWrapper.style.display="none",remainSec.innerHTML=""):remainSec.innerHTML=a}),peer.on("start",function(a){console.log("start");myId=peer.getMyId();raceMember=a;for(var b=0,f=a.length;b<f;b++)myId!=a[b].id&&raceMemberIdList.push(a[b].id),memberRapMap[a[b].id]=0;clearInterval(roonListCntChk);
startScene.remove();canvasWrapper.style.display="block";animate();startInit()}),peer.on("timeout",function(a){console.log("timeout");roomListWrapper.style.display="none";inputWrapper.style.display="block"}),peer.on("data",function(a){a=JSON.parse(a);draw(a)}),peer.on("goal",function(a){console.log("goal "+a);peer.getMyId()===a?document.getElementById("win").style.display="block":document.getElementById("lose").style.display="block";setTimeout(function(){isFinished=!0},4500)})):alert("please use half-width alphanumeric")},
!1);newGameBtn.addEventListener("click",function(a){peer.create(myName.value);roomListWrapper.style.display="none";joinMemberList.innerHTML="";waitWrapper.style.display="block"},!1);
var setJoinBtnEvents=function(){if(roomInfo)for(var a=0,d=roomInfo.length;a<d;a++){var b=document.getElementById("joinBtn_"+roomInfo[a].roomId);b&&(joinBtns.push(b),b.addEventListener("click",function(a){b.removeEventListener("click",arguments.callee,!1);var d=a.target.dataset.roomId;document.getElementById("roomMemberList_"+d).innerHTML+=" "+myName.value;joinedRoomId=d;peer.join(roomMemberMap[d],d,myName.value);removeBtn();document.getElementById("joinTxt_"+d).style.display="block"},!1))}},removeBtn=
function(){for(var a=0,d=joinBtns.length;a<d;a++)joinBtns[a].style.display="none";newGameBtn.style.display="none"},updateRoomInfo=function(a,d,b){joinedRoomId||(joinedRoomId=a);d!=peer.getMyId()&&(roomMemberMap[a]||(roomMemberMap[a]=[]),roomMemberMap[a].push(d))},roonListCntChk=setInterval(function(){if(roomInfo)for(var a=0,d=roomInfo.length;a<d;a++){var b=roomInfo[a].remainTime-=1,f=roomInfo[a].roomId,g=document.getElementById("roomRemainSec_"+f);if(g)if(0>=b){g.innerHTML=0;if(joinedRoomId)break;
document.getElementById("joinBtn_"+f).style.display="none";document.getElementById("closeTxt_"+f).style.display="block"}else g.innerHTML=b}},1E3),formCheck=function(a){return""===a.replace(/\s+/g,"")||a.match(/[^A-Za-z\s.-]+/)?!1:!0};